sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/BusyIndicator","sap/m/Token","marathonpetroleum/hsc/pricingui/utils/constants","sap/m/SearchField"],function(e,t,i,a,o,r,s,l,n){"use strict";return e.extend("marathonpetroleum.hsc.pricingui.controller.editCust",{onInit:function(){this.oBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.oDataModelE=this.getOwnerComponent().getModel();var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("RouteEditView").attachPatternMatched(this.onRouteEditCustomer,this)},onRouteEditCustomer:function(){r.show();var e=new i,a=this;var o=this.getOwnerComponent().getModel("oModel");var s=o.oData.selectedRow;this.oDataModelE.callFunction("/getCustomer",{method:l.httpGet,async:false,urlParameters:{customer:s[l.INTZERO].Customer,shipTo:s[l.INTZERO].ShipTo},success:function(e){r.hide();var t=e.getCustomer.data;if(t){var i=e.getCustomer.data.UpdTimestamp,o=i.match(/\(([^)]+)\)/)[1],s=new Date(parseInt(o)),l=s.toISOString(),n=l.replace(/\.\d+Z$/,"");a.getView().getModel("detailModel").setProperty("/CustEtag",n)}},error:function(e){r.hide();t.error(a.oBundle.getText("techError"),{details:e})}});this.getView().byId("idInputCustomerID").setValue(s[l.INTZERO].Customer);this.getView().byId("idInputCustomerName").setValue(s[l.INTZERO].CustomerName);this.getView().byId("idInputShipToID").setValue(s[l.INTZERO].ShipTo);this.getView().byId("idInputShipToName").setValue(s[l.INTZERO].ShipToName);this.getView().byId("idMultiComboBoxTerminal").removeAllTokens();this.getView().byId("idMultiComboBoxProducts").removeAllTokens();var n=[],u=[];if(s[l.INTZERO].ProductList.length!=l.INTZERO){for(var d=l.INTZERO;d<s[l.INTZERO].ProductList.length;d++){var h=new sap.m.Token({key:s[l.INTZERO].ProductList[d].Product,text:s[l.INTZERO].ProductList[d].ProductName});n.push(h)}this.getView().byId("idMultiComboBoxProducts").setTokens(n)}if(s[l.INTZERO].TerminalList.length!=l.INTZERO){for(var d=l.INTZERO;d<s[l.INTZERO].TerminalList.length;d++){var g=new sap.m.Token({key:s[l.INTZERO].TerminalList[d].Terminal,text:s[l.INTZERO].TerminalList[d].TerminalName});u.push(g)}this.getView().byId("idMultiComboBoxTerminal").setTokens(u)}e.setData({items:s[l.INTZERO].EmailArray});this.getView().setModel(e,"detailModel");this.getView().byId("idInputEmail").setModel(e,"detailModel");this.getView().byId("idCheckBoxDaily").setSelected(s[l.INTZERO].DailyJob);this.getView().byId("idCheckBoxOnDemand").setSelected(s[l.INTZERO].OnDemandJob);this.getView().getModel("detailModel").setProperty("/ProductData",o.oData.ProductData);this.getView().getModel("detailModel").setProperty("/TerminalData",o.oData.TerminalData)},onPressSaveEditCust:function(){var e=this.getView().byId("idInputCustomerID").getValue(),i=this.getView().byId("idInputCustomerName").getValue(),a=this.getView().byId("idInputShipToID").getValue(),o=this.getView().byId("idInputShipToName").getValue(),s=this.getView().byId("idMultiComboBoxProducts").getTokens(),n=this.getView().byId("idMultiComboBoxTerminal").getTokens(),u=this.getView().byId("idInputEmail").getTokens(),d=this,h=this.getView().byId("idCheckBoxDaily").getSelected(),g=[],c=[],m=this.getView().byId("idCheckBoxOnDemand").getSelected(),p="";if(h===true||m===true){if(s.length===l.INTZERO||n.length===l.INTZERO){r.hide();t.error(d.oBundle.getText("errormsgCheckBox"));return}}if(e!==""&&i!==""&&a!==""&&o!==""&&u.length!==l.INTZERO){r.show();for(var T=l.INTZERO;T<s.length;T++){var f={Customer:e,ShipTo:a,Product:s[T].getKey()};g.push(f)}for(var T=l.INTZERO;T<n.length;T++){var f={Customer:e,ShipTo:a,Terminal:n[T].getKey()};c.push(f)}for(var V=l.INTZERO;V<u.length;V++){var I=u[V].getKey();if(V===l.INTZERO){p=I}else{p=p+l.spliter+I}}var w={Customer:e,ShipTo:a,CustomerName:i,ShipToName:o,DailyJob:h,OnDemandJob:m,EmailTo:p,ProductList:g,TerminalList:c};var d=this;var C=JSON.stringify(w),b=this.getView().getModel("detailModel").getProperty("/CustEtag");d.oDataModelE.callFunction("/updateCustomer",{method:l.httpPost,urlParameters:{etag:b,createData:C},success:function(e){r.hide();if(e.updateCustomer.data.status!==undefined&&e.updateCustomer.data.status!==200){if(e.updateCustomer.data.status===412){var i=d.oBundle.getText("msgError");t.error(i)}else{var i=e.updateCustomer.data.message;t.error(i)}}else{d.getView().getModel("detailModel").setProperty("/CustEtag",l.SPACE);t.success(d.oBundle.getText("savedSucc"),{onClose:function(e){if(e===t.Action.OK){d.onBack();r.hide()}}})}},error:function(e){r.hide();var i=e.message;t.error(i,{details:e})}})}else{r.hide();t.error(d.oBundle.getText("errormsgrequired"))}},onBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("RoutecontrolView")},onEmailChangeEditCust:function(e){var t=this.getView().byId("idInputEmail");var i=e.getParameters().value;var a=function(e){var i=e.text;var a=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(!a.test(i)){t.setValueState(sap.ui.core.ValueState.Error)}else{t.setValueState(sap.ui.core.ValueState.None);return new s({key:i,text:i})}};if(i===""){t.setValueState(sap.ui.core.ValueState.None)}t.addValidator(a)},onTerminalValueHelpRequested:function(){this._oBasicSearchField=new n;this.oColModel=new i;var e={cols:[{label:"Terminal ID",template:"Terminal"},{label:"Terminal Name",template:"TerminalName"}]};this.oTerminalModel=this.getView().getModel("detailModel");this.oColModel.setData(e);this._oValueHelpDialogTr=sap.ui.xmlfragment(l.fragmentTerVH,this);this.getView().addDependent(this._oValueHelpDialogTr);var t=this._oValueHelpDialogTr.getFilterBar();t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.attachSearch(function(){t.search()});this._oValueHelpDialogTr.getTableAsync().then(function(t){t.setModel(this.oTerminalModel);t.setModel(this.oColModel,"columns");if(t.bindRows){t.bindAggregation("rows","/TerminalData")}if(t.bindItems){t.bindAggregation("items","/TerminalData",function(){return new ColumnListItem({cells:e.map(function(e){return new Label({text:"{"+e.template+"}"})})})})}this._oValueHelpDialogTr.update()}.bind(this));this._oValueHelpDialogTr.setTokens(this.getView().byId("idMultiComboBoxTerminal").getTokens());this._oValueHelpDialogTr.open()},onFilterBarSearchTer:function(e){var t=this._oBasicSearchField.getValue(),i=e.getParameter("selectionSet");var r=i.reduce(function(e,t){if(t.getValue()){if(t.getName()==="Terminal ID"){e.push(new a({path:l.pathTer,operator:o.Contains,value1:t.getValue()}))}else if(t.getName()===l.terName){e.push(new a({path:l.pathTName,operator:o.Contains,value1:t.getValue()}))}}return e},[]);r.push(new a({filters:[new a({path:l.pathTer,operator:o.Contains,value1:t}),new a({path:l.pathTName,operator:o.Contains,value1:t})],and:false}));this._filterTableTr(new a({filters:r,and:true}))},_filterTableTr:function(e){var t=this._oValueHelpDialogTr;t.getTableAsync().then(function(i){if(i.bindRows){i.getBinding("rows").filter(e)}if(i.bindItems){i.getBinding("items").filter(e)}t.update()})},onValueHelpOkPressTer:function(e){var t=e.getParameter("tokens");this.getView().byId("idMultiComboBoxTerminal").setTokens(t);this._oValueHelpDialogTr.close()},onValueHelpCancelPressTer:function(){this._oValueHelpDialogTr.close();this._oValueHelpDialogTr.destroy()},onProductsValueHelpRequested:function(){this._oBasicSearchField=new n;this.oColModel=new i;var e={cols:[{label:"Product ID",template:"Product"},{label:"Product Name",template:"ProductName"}]};this.oProductsModel=this.getView().getModel("detailModel");this.oColModel.setData(e);this._oValueHelpDialog=sap.ui.xmlfragment(l.fragmentProdVH,this);this.getView().addDependent(this._oValueHelpDialog);var t=this._oValueHelpDialog.getFilterBar();t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.attachSearch(function(){t.search()});this._oValueHelpDialog.getTableAsync().then(function(t){t.setModel(this.oProductsModel);t.setModel(this.oColModel,"columns");if(t.bindRows){t.bindAggregation("rows","/ProductData")}if(t.bindItems){t.bindAggregation("items","/ProductData",function(){return new ColumnListItem({cells:e.map(function(e){return new Label({text:"{"+e.template+"}"})})})})}this._oValueHelpDialog.update()}.bind(this));this._oValueHelpDialog.setTokens(this.getView().byId("idMultiComboBoxProducts").getTokens());this._oValueHelpDialog.open()},onFilterBarSearchProd:function(e){var t=this._oBasicSearchField.getValue(),i=e.getParameter("selectionSet");var r=i.reduce(function(e,t){if(t.getValue()){if(t.getName()==="Product ID"){e.push(new a({path:l.pathProd,operator:o.Contains,value1:t.getValue()}))}else if(t.getName()===l.prodName){e.push(new a({path:l.pathProdName,operator:o.Contains,value1:t.getValue()}))}}return e},[]);r.push(new a({filters:[new a({path:l.pathProd,operator:o.Contains,value1:t}),new a({path:l.pathProdName,operator:o.Contains,value1:t})],and:false}));this._filterTable(new a({filters:r,and:true}))},_filterTable:function(e){var t=this._oValueHelpDialog;t.getTableAsync().then(function(i){if(i.bindRows){i.getBinding("rows").filter(e)}if(i.bindItems){i.getBinding("items").filter(e)}t.update()})},onValueHelpOkPressProd:function(e){var t=e.getParameter("tokens");this.getView().byId("idMultiComboBoxProducts").setTokens(t);this._oValueHelpDialog.close()},onValueHelpCancelPressProd:function(){this._oValueHelpDialog.close();this._oValueHelpDialog.destroy()},onValueHelpAfterClose:function(){this._oValueHelpDialog.destroy()},getTodosViaPromise:function(){return new Promise(function(e,t){var i=this.getView().getModel();if(!i){t("couldn't load the application model")}else{e(i.getProperty("/todos"))}}.bind(this))}})});
sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/BusyIndicator","sap/m/Token","marathonpetroleum/hsc/pricingui/utils/constants","sap/m/SearchField"],function(e,t,a,o,i,r,n,s,l,u){"use strict";return e.extend("marathonpetroleum.hsc.pricingui.controller.createCust",{onInit:function(){this.oBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.oDataModel=this.getOwnerComponent().getModel();var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("RoutecreateView").attachPatternMatched(this.onRouteCustomer,this);var t=new a;var o=[];t.setData(o);this.getView().setModel(t,"oCustModel")},onRouteCustomer:function(){var e=this.getOwnerComponent().getModel("oModel");this.getF4CustomerCreate();this.getView().getModel("oCustModel").setProperty("/ProductData",e.oData.ProductData);this.getView().getModel("oCustModel").setProperty("/TerminalData",e.oData.TerminalData);this.getView().byId("idInputCustomerIDAdd").setValue(""),this.getView().byId("idInputCustomerNameAdd").setValue(""),this.getView().byId("idInputSHAdd").setValue(""),this.getView().byId("idInputSHNameAdd").setValue(""),this.getView().byId("idMultiComboBoxTerminalAdd").removeAllTokens(),this.getView().byId("idMultiComboBoxProductsAdd").removeAllTokens(),this.getView().byId("idInputEmailAdd").removeAllTokens(),this.getView().byId("daily_distribution").setSelected(false),this.getView().byId("on_demand_distribution").setSelected(false)},getF4CustomerCreate:function(){var e=this;this.oDataModel.callFunction("/getOnPremCustomerF4",{method:l.httpGet,success:function(t){var a=t.getOnPremCustomerF4.data;a.sort(function(e,t){return e.Customer.localeCompare(t.Customer)||t.Shipto-e.Shipto});e.getView().getModel("oCustModel").setProperty("/CustValHelp",a);n.hide()},error:function(a){n.hide();t.error(e.oBundle.getText("techError"),{details:a})}})},handleSearch:function(e){var t=e.getParameter("value");var a=[],o=[];if(t&&t.length>l.INTZERO){a.push(new i({filters:[new i({path:l.pathCus,operator:r.Contains,value1:t}),new i({path:l.pathCName,operator:r.Contains,value1:t}),new i({path:l.pathSH2,operator:r.Contains,value1:t}),new i({path:l.pathSHName2,operator:r.Contains,value1:t})],and:false}));o.push(new i({filters:a,and:true}))}var n=e.getSource().getBinding("items");n.filter([o])},handleConfirm:function(e){var t=e.getSource().getBinding("items");t.filter([]);var a=e.getParameter("selectedContexts");if(a&&a.length){this.getView().byId("idInputCustomerIDAdd").setValue(a.map(function(e){return e.getObject().Customer}));this.getView().byId("idInputCustomerNameAdd").setValue(a.map(function(e){return e.getObject().CustomerName}));this.getView().byId("idInputSHAdd").setValue(a.map(function(e){return e.getObject().Shipto}));this.getView().byId("idInputSHNameAdd").setValue(a.map(function(e){return e.getObject().ShiptoName}))}},onValueHelpRequestedcust:function(){var e=this.getView();if(!this.byId("openDialog")){o.load({id:e.getId(),name:l.fargmentCusF4,controller:this}).then(function(t){e.addDependent(t);t.open()})}else{this.byId("openDialog").open()}},onValueHelpCancelPress:function(){this.byId("openDialog").close()},onBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("RoutecontrolView")},onSaveCustomer:function(){n.show();var e=this.getView().byId("idInputCustomerIDAdd").getValue(),a=this.getView().byId("idInputCustomerNameAdd").getValue(),o=this.getView().byId("idInputSHAdd").getValue(),i=this.getView().byId("idInputSHNameAdd").getValue(),r=this.getView().byId("idMultiComboBoxProductsAdd").getTokens(),s=this.getView().byId("idMultiComboBoxTerminalAdd").getTokens(),u=this.getView().byId("idInputEmailAdd").getTokens(),d=this,h=this.getView().byId("daily_distribution").getSelected(),g=[],c=[],p=this.getView().byId("on_demand_distribution").getSelected(),m="";if(h===true||p===true){if(r.length===l.INTZERO||s.length===l.INTZERO){n.hide();t.error(d.oBundle.getText("errormsgCheckBox"));return}}if(e!==""&&a!==""&&o!==""&&i!==""&&u.length!==l.INTZERO){for(var f=l.INTZERO;f<r.length;f++){var V={Customer:e,ShipTo:o,Product:r[f].getKey()};g.push(V)}for(var f=l.INTZERO;f<s.length;f++){var V={Customer:e,ShipTo:o,Terminal:s[f].getKey()};c.push(V)}for(var C=l.INTZERO;C<u.length;C++){var w=u[C].getKey();if(C===l.INTZERO){m=w}else{m=m+l.spliter+w}}var b={Customer:e,ShipTo:o,CustomerName:a,ShipToName:i,DailyJob:h,OnDemandJob:p,EmailTo:m,ProductList:g,TerminalList:c};var T=JSON.stringify(b);this.oDataModel.callFunction("/createCustomer",{method:l.httpPost,urlParameters:{createData:T},success:function(e){n.hide();if(e.createCustomer.data.status!==undefined&&e.createCustomer.data.status!==200){t.error(e.createCustomer.data.message)}else{t.success(d.oBundle.getText("customerCreated",[e.createCustomer.data.Customer,e.createCustomer.data.ShipTo]),{onClose:function(e){if(e===t.Action.OK){d.onBack()}}})}},error:function(e){n.hide();var a=e.message;t.error(a,{details:e})}})}else{n.hide();t.error(d.oBundle.getText("errormsgrequired"))}},onProductsValueHelpRequestedAdd:function(){this._oBasicSearchField=new u;this.oColModel=new a;var e={cols:[{label:"Product ID",template:"Product"},{label:"Product Name",template:"ProductName"}]};this.oProductsModel=this.getView().getModel("oCustModel");this.oColModel.setData(e);this._oValueHelpDialog=sap.ui.xmlfragment(l.fragmentProdVH,this);this.getView().addDependent(this._oValueHelpDialog);var t=this._oValueHelpDialog.getFilterBar();t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.attachSearch(function(){t.search()});this._oValueHelpDialog.getTableAsync().then(function(t){t.setModel(this.oProductsModel);t.setModel(this.oColModel,"columns");if(t.bindRows){t.bindAggregation("rows","/ProductData")}if(t.bindItems){t.bindAggregation("items","/ProductData",function(){return new ColumnListItem({cells:e.map(function(e){return new Label({text:"{"+e.template+"}"})})})})}this._oValueHelpDialog.update()}.bind(this));this._oValueHelpDialog.setTokens(this.getView().byId("idMultiComboBoxProductsAdd").getTokens());this._oValueHelpDialog.open()},onFilterBarSearchProd:function(e){var t=this._oBasicSearchField.getValue(),a=e.getParameter("selectionSet");var o=a.reduce(function(e,t){if(t.getValue()){if(t.getName()===l.prodID){e.push(new i({path:l.pathProd,operator:r.Contains,value1:t.getValue()}))}else if(t.getName()===l.prodName){e.push(new i({path:l.pathProdName,operator:r.Contains,value1:t.getValue()}))}}return e},[]);o.push(new i({filters:[new i({path:l.pathProd,operator:r.Contains,value1:t}),new i({path:l.pathProdName,operator:r.Contains,value1:t})],and:false}));this._filterTable(new i({filters:o,and:true}))},_filterTable:function(e){var t=this._oValueHelpDialog;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},onValueHelpOkPressProd:function(e){var t=e.getParameter("tokens");this.getView().byId("idMultiComboBoxProductsAdd").setTokens(t);this._oValueHelpDialog.close()},onValueHelpCancelPressProd:function(){this._oValueHelpDialog.close();this._oValueHelpDialog.destroy()},onTerminalValueHelpRequestedAdd:function(){this._oBasicSearchField=new u;this.oColModel=new a;var e={cols:[{label:"Terminal ID",template:"Terminal"},{label:"Terminal Name",template:"TerminalName"}]};this.oProductsModel=this.getView().getModel("oCustModel");this.oColModel.setData(e);this._oValueHelpDialogTr=sap.ui.xmlfragment(l.fragmentTerVH,this);this.getView().addDependent(this._oValueHelpDialogTr);var t=this._oValueHelpDialogTr.getFilterBar();t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.attachSearch(function(){t.search()});this._oValueHelpDialogTr.getTableAsync().then(function(t){t.setModel(this.oProductsModel);t.setModel(this.oColModel,"columns");if(t.bindRows){t.bindAggregation("rows","/TerminalData")}if(t.bindItems){t.bindAggregation("items","/TerminalData",function(){return new ColumnListItem({cells:e.map(function(e){return new Label({text:"{"+e.template+"}"})})})})}this._oValueHelpDialogTr.update()}.bind(this));this._oValueHelpDialogTr.setTokens(this.getView().byId("idMultiComboBoxTerminalAdd").getTokens());this._oValueHelpDialogTr.open()},onFilterBarSearchTer:function(e){var t=this._oBasicSearchField.getValue(),a=e.getParameter("selectionSet");var o=a.reduce(function(e,t){if(t.getValue()){if(t.getName()===l.terID){e.push(new i({path:l.pathTer,operator:r.Contains,value1:t.getValue()}))}else if(t.getName()===l.terName){e.push(new i({path:l.pathTName,operator:r.Contains,value1:t.getValue()}))}}return e},[]);o.push(new i({filters:[new i({path:l.pathTer,operator:r.Contains,value1:t}),new i({path:l.pathTName,operator:r.Contains,value1:t})],and:false}));this._filterTableTr(new i({filters:o,and:true}))},_filterTableTr:function(e){var t=this._oValueHelpDialogTr;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},onValueHelpOkPressTer:function(e){var t=e.getParameter("tokens");this.getView().byId("idMultiComboBoxTerminalAdd").setTokens(t);this._oValueHelpDialogTr.close()},onValueHelpCancelPressTer:function(){this._oValueHelpDialogTr.close();this._oValueHelpDialogTr.destroy()},onEmailChangeAddCust:function(e){var t=this.getView().byId("idInputEmailAdd");var a=e.getParameters().value;var o=function(e){var a=e.text;var o=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(!o.test(a)){t.setValueState(sap.ui.core.ValueState.Error)}else{t.setValueState(sap.ui.core.ValueState.None);return new s({key:a,text:a})}};if(a===""){t.setValueState(sap.ui.core.ValueState.None)}t.addValidator(o)},onEmailEnter:function(e){if(e.getSource().getValue().includes("\n")){this.onEmailChangeAddCust(e)}}})});